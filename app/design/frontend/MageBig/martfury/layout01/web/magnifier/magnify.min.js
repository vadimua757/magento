define(["jquery","underscore","magnifier/magnifier"],function(t,e){"use strict";return function(o,a){function n(t){var e=new Image,o={rw:0,rh:0};return e.src=t,o.rw=e.width,o.rh=e.height,o}function i(t){var e,o,a=t.height(),n=t.width(),i=t.parent().height(),r=t.parent().width();(n>r||a>i)&&(n/a<r/i?(e=i,o=n*(i/a)):(o=r,e=a*r/n),t.css({"min-width":o,"min-height":e}))}function r(t,e){e?t.css({"min-width":t.width(),"min-height":t.height(),width:t.width(),height:t.height()}).addClass(x):(t.css({width:"",height:"",top:"",left:"",right:"",bottom:""}).removeClass(x),i(t))}function s(t){B=!0,A=k=W=!1,t.hasClass(Y)&&t.removeClass(Y),r(t,!1)}function h(e){e?(t($).addClass(I),t(_).addClass(L)):(t($).removeClass(I),t(_).removeClass(L))}function f(t,e){var o=new Image;o.onload=function(){h(this.height>e.parent().height()||this.width>e.parent().width()?!1:!0)},o.src=t}function l(t,e,o){var a=t.attr("src");!a||e||o?h(!0):f(a,t)}function d(e,o){var a,r,h,f,d;e.data.$image&&e.data.$image.length&&(a=n(t(D)[0].src),r=e.data.$image.parent().width(),h=e.data.$image.parent().height(),f=r>=a.rw&&h>=a.rh,d=r>e.data.$image.width()&&h>e.data.$image.height(),l(e.data.$image,z,C(e.data.fotorama.activeFrame.$stageFrame)),i(e.data.$image),(e.data.$image.hasClass(x)&&!A||f||d)&&s(e.data.$image),f||g())}function u(t,e,o,a,n){var i;return parseInt(t.css("marginTop"))||parseInt(t.css("marginLeft"))?(i=k?e-o/4:0,i=i<n-a?n-a:i,i=i>a-n?a-n:i):(i=e+o/2,i=i<n-a?n-a:i,i=i>0?0:i,!k&&o<0&&(i=i<(n-a)/2?(n-a)/2:i)),i}function c(t,e,o,a){var n;return n=t+e/2,n=n<a-o?a-o:n,n=n>0?0:n,!k&&e<0&&(n=n<(a-o)/2?(a-o)/2:n),n}function m(e,o,a,n){var i,r,s,h,f,l,d,m,g;t(O).data("fotorama").fullScreen&&(W=!0,i=e.parent(),r=i.width(),s=i.height(),f=e.position().top,l=e.position().left,g=e.width()/e.height(),o.height=isNaN(o.height)?o.width/g:o.height,o.width=isNaN(o.width)?o.height*g:o.width,f=o.height>=s?u(e,f,n,o.height,s):0,l=o.width>=r?c(l,a,o.width,r):0,d=k&&l<(r-o.width)/2?0:l,m=k?0:f,h=t.extend(o,{top:f,bottom:m,left:l,right:d}),e.css(h))}function g(){var o,a=t("a[href], area[href], input, select, textarea, button, iframe, object, embed, *[tabindex], *[contenteditable]").not("[tabindex=-1], [disabled], :hidden"),n=t(O).data("fotorama"),i=t(":focus");n.fullScreen&&(a.each(function(e){t(this).is(i)&&(o=e)}),n.setOptions({swipe:!A,keyboard:!A}),e.isNumber(o)&&a.eq(o).focus())}function v(e,a,i){var s,h,f,l,d,u,c,v,p,w={};return!B||P&&W||!z&&t($).hasClass(I)||(s=t(D),h=n(s[0].src),f=s.width(),l=s.height(),p=f/l,A=!0,g(),s.hasClass(x)||r(s,!0),e.preventDefault(),f>=l?(d=a||Math.ceil(f*parseFloat(o.magnifierOpts.fullscreenzoom)/100),c=f+d,c>=h.rw&&(c=h.rw,d=a||c-f,B=!1),v=c/p,u=i||v-l):(u=i||Math.ceil(l*parseFloat(o.magnifierOpts.fullscreenzoom)/100),v=l+u,v>=h.rh&&(v=h.rh,u=i||v-l,B=!1),c=v*p,d=a||c-f),f>=l&&f!==h.rw?(w=t.extend(w,{width:c,height:"auto"}),m(s,w,-d,-u)):f<l&&l!==h.rh&&(w=t.extend(w,{width:"auto",height:v}),m(s,w,-d,-u))),!1}function p(e,a,n){var i,r,s,h,f,l,d,u,c,v,p,w;return!A||P&&W||!z&&t(_).hasClass(L)||(B=!0,i=t(D),f=i.parent().width(),l=i.parent().height(),d=i.width(),u=i.height(),p=d/u,e.preventDefault(),d>=u?(c=a||Math.ceil(d*parseFloat(o.magnifierOpts.fullscreenzoom)/100),r=d-c,s=r/p,v=n||u-s):(v=n||Math.ceil(u*parseFloat(o.magnifierOpts.fullscreenzoom)/100),s=u-v,r=s*p,c=a||d-r),w=function(){p>f/l?(r=f,c=d-r,s=r/p,v=u-s,h={width:r,height:"auto"}):(s=l,v=u-s,r=s*p,c=d-r,h={width:"auto",height:s}),m(i,h,c,v)},d>=u?r>f?(h={width:r,height:"auto"},m(i,h,c,v)):s>l?(h={width:r,height:"auto"},m(i,h,c,v)):(A=k=!1,g(),w()):s>l?(h={width:"auto",height:s},m(i,h,c,v)):r>f?(h={width:"auto",height:s},m(i,h,c,v)):(A=k=!1,g(),w())),!1}function w(e,o,a){function n(e){var o=e.deltaY||e.wheelDelta,a=e||window.event;t(O).data("fotorama").fullScreen&&(e.deltaY?o>0?p(a):v(a):o>0?v(a):p(a),e.preventDefault?e.preventDefault():e.returnValue=!1)}var i=o.activeFrame.$stageFrame,r=i.get(0);i.hasClass("magnify-wheel-loaded")||r&&r.addEventListener&&("onwheel"in document?r.addEventListener("wheel",n):"onmousewheel"in document?r.addEventListener("mousewheel",n):r.addEventListener("MozMousePixelScroll",n),i.addClass("magnify-wheel-loaded"))}function y(o){function a(o,a,n){var i=+c+a,r=+u+o,s=E.width()/10+20;return k=!0,E.offset().left===T.offset().left+T.width()-E.width()&&39===n.keyCode||S-1<T.offset().left+T.width()-E.width()&&o<0&&e.isNumber(S)&&("mousemove"===n.type||"touchmove"===n.type||"pointermove"===n.type||"MSPointerMove"===n.type)?(S=null,void g(">")):E.offset().left===T.offset().left&&0!==o&&37===n.keyCode||S===T.offset().left&&o>0&&("mousemove"===n.type||"touchmove"===n.type||"pointermove"===n.type||"MSPointerMove"===n.type)?(S=null,void g("<")):(E.height()>T.height()&&(i=T.offset().top+T.height()>i+E.height()?T.offset().top+T.height()-E.height():T.offset().top<i?0:i,E.offset({top:i}),E.css("bottom","")),E.width()>T.width()?(r=T.offset().left+T.width()>r+E.width()?T.offset().left+T.width()-E.width():T.offset().left<r?T.offset().left:r,E.offset({left:r}),E.css("right","")):Math.abs(a)<1&&A&&"mousemove"!==n.type&&"touchmove"!==n.type&&"pointermove"!==n.type&&"MSPointerMove"!==n.type&&(o<0?t(O).data("fotorama").show(">"):t(O).data("fotorama").show("<")),void(E.width()<=T.width()&&A&&("mousemove"===n.type||"touchmove"===n.type||"pointermove"===n.type||"MSPointerMove"===n.type)&&Math.abs(o)>Math.abs(a)&&Math.abs(o)>s&&g(o<0?">":"<")))}function i(t){var e,o=n(E[0].src);o.rh<E.parent().height()&&o.rw<E.parent().width()||(e=o.rw/o.rh,B?v(t,o.rw-E.width(),o.rh-E.height()):e>T.width()/T.height()?p(t,o.rw-T.width(),o.rw/e):p(t,o.rw*e,o.rh-T.height()))}function r(t){var e=(new Date).getTime(),o=e-j;o<400&&o>0?(W=!1,j=0,i(t)):j=(new Date).getTime()}function s(t){return Math.sqrt((t.touches[0].clientX-t.touches[1].clientX)*(t.touches[0].clientX-t.touches[1].clientX)+(t.touches[0].clientY-t.touches[1].clientY)*(t.touches[0].clientY-t.touches[1].clientY))}var h,f,u,c,m,g,w,y=!1,M=t(O),E=t(D,M),T=t('[data-gallery-role="stage-shaft"] [data-active="true"]'),F=M.data("fotorama");g=e.throttle(function(e){t(O).data("fotorama").show(e)},500,{trailing:!1}),z?(E.off("tap"),E.on("tap",function(t){0===t.originalEvent.originalEvent.touches.length&&r(t)})):(E.unbind("dblclick"),E.dblclick(i)),F.fullScreen&&l(E,z,C(o.activeFrame.$stageFrame)),E.off(z?"touchstart":"pointerdown mousedown MSPointerDown"),E.on(z?"touchstart":"pointerdown mousedown MSPointerDown",function(t){t&&t.originalEvent.touches&&t.originalEvent.touches.length>=2?(t.preventDefault(),w=s(t.originalEvent),y=!1,E.hasClass(Y)&&E.removeClass(Y)):!F.fullScreen||P&&W||(t.preventDefault(),c=E.offset().top,u=E.offset().left,z&&(m=t.originalEvent.touches[0]||t.originalEvent.changedTouches[0],t.clientX=m.pageX,t.clientY=m.pageY),h=t.clientX||t.originalEvent.clientX,f=t.clientY||t.originalEvent.clientY,y=!0),E.offset()&&E.width()>T.width()&&(S=E.offset().left)}),E.off(z?"touchmove":"mousemove pointermove MSPointerMove"),E.on(z?"touchmove":"mousemove pointermove MSPointerMove",function(t){if(t&&t.originalEvent.touches&&t.originalEvent.touches.length>=2){t.preventDefault();var e=s(t.originalEvent);E.hasClass(Y)&&E.removeClass(Y),e<w?(p(t),w=e):e>w&&(v(t),w=e)}else{var o,n;!F.fullScreen||!y||P&&W||(A&&!E.hasClass(Y)&&E.addClass(Y),o=t.clientX||t.originalEvent.clientX,n=t.clientY||t.originalEvent.clientY,t.preventDefault(),z&&(m=t.originalEvent.touches[0]||t.originalEvent.changedTouches[0],o=m.pageX,n=m.pageY),A&&a(o-h,n-f,t))}}),E.off("transitionend webkitTransitionEnd mozTransitionEnd msTransitionEnd "),E.on("transitionend webkitTransitionEnd mozTransitionEnd msTransitionEnd",function(){W=!1}),b&&t(document).unbind("keydown",b),b=function(e){var o=40,n=t(":focus"),i=t(O).data("fotorama").fullScreen,r=function(){u=t(D,M).offset().left,c=t(D,M).offset().top};!n.attr("data-gallery-role")&&n.length||!A||(i&&(u=t(D,t(O)).offset().left,c=t(D,t(O)).offset().top),39===e.keyCode&&i&&(r(),a(-o,0,e)),38===e.keyCode&&i&&(r(),a(0,o,e)),37===e.keyCode&&i&&(r(),a(o,0,e)),40===e.keyCode&&i&&(e.preventDefault(),r(),a(0,-o,e))),27===e.keyCode&&i&&A&&t(O).data("fotorama").cancelFullScreen()},t(document).keydown(b),t(document).on(z?"touchend":"mouseup pointerup MSPointerUp",function(t){F.fullScreen&&(E.offset()&&E.width()>T.width()&&(S=E.offset().left),y=!1,E.removeClass(Y))}),t(window).off("resize",d),t(window).on("resize",{$image:E,fotorama:o},d)}function C(t){return t.hasClass(q)}function M(e,o){var a=[e.pageX,e.pageY],n="arrow"===t(e.target).data("gallery-role"),i=o[0]===a[0]&&o[1]===a[1],r=t(e.target).parent().data("active");(n||r&&!i)&&E()}var b,E,k,S,P,z="ontouchstart"in document.documentElement,O='[data-gallery-role="gallery"]',T='[data-gallery-role="magnifier"]',F='[data-gallery-role="magnifier-zoom"]',$='[data-gallery-role="fotorama__zoom-in"]',_='[data-gallery-role="fotorama__zoom-out"]',D='[data-gallery-role="stage-shaft"] [data-active="true"] .fotorama__img--full',Y="fotorama__img--draggable",x="fotorama__img--zoommable",X="zoom-in-loaded",N="zoom-out-loaded",I="fotorama__zoom-in--disabled",L="fotorama__zoom-out--disabled",q="fotorama-video-container",W=!1,j=0,A=!1,B=!0;return z=z&&(navigator.maxTouchPoints||navigator.msMaxTouchPoints)&&navigator.userAgent.match(/Android|webOS|iPhone|iPad|iPod|BlackBerry|Windows Phone/i),z&&t(a).on("fotorama:showend fotorama:load",function(){t(T).remove(),t(F).remove()}),function(){var t=document.documentElement.style;void 0!==t.transition||void 0!==t.WebkitTransition||void 0!==t.MozTransition||void 0!==t.MsTransition||void 0!==t.OTransition}(),E=function(){t(T).empty().hide(),t(F).remove()},o.magnifierOpts.enabled&&t(a).on("pointerdown mousedown MSPointerDown",function(e){var o=[e.pageX,e.pageY];t(a).on("mousemove pointermove MSPointerMove",function(t){navigator.msPointerEnabled?E():M(t,o)}),t(document).on("mouseup pointerup MSPointerUp",function(){t(a).off("mousemove pointermove MSPointerMove")})}),t.extend(o.magnifierOpts,{zoomable:!1,thumb:".fotorama__img",largeWrapper:'[data-gallery-role="magnifier"]',height:o.magnifierOpts.height||function(){return t('[data-active="true"]').height()},width:o.magnifierOpts.width||function(){var e=t(O).parent().parent();return e.parent().width()-e.width()-20},left:o.magnifierOpts.left||function(){return t(O).offset().left+t(O).width()+20},top:o.magnifierOpts.top||function(){return t(O).offset().top}}),t(a).on("fotorama:load fotorama:showend fotorama:fullscreenexit fotorama:ready",function(e,a){var n=t(O).data("fotorama").activeFrame.$stageFrame;n.find(F).length||(E(),o.magnifierOpts&&(o.magnifierOpts.large=t(O).data("fotorama").activeFrame.img,o.magnifierOpts.full=a.data[a.activeIndex].original,!C(n)&&t(n).magnify(o.magnifierOpts)))}),t(a).on("gallery:loaded",function(o){var n;t(a).find(O).on("fotorama:ready",function(e,o){var a=t($),n=t(_);a.hasClass(X)||(a.on("click touchstart",v),a.on("mousedown",function(t){t.stopPropagation()}),a.keyup(function(t){13===t.keyCode&&v(t)}),t(window).keyup(function(t){(107===t.keyCode||o.fullscreen)&&v(t)}),a.addClass(X)),n.hasClass(N)||(n.on("click touchstart",p),n.on("mousedown",function(t){t.stopPropagation()}),n.keyup(function(t){13===t.keyCode&&p(t)}),t(window).keyup(function(t){(109===t.keyCode||o.fullscreen)&&p(t)}),n.addClass(N))}).on("fotorama:fullscreenenter fotorama:showend",function(e,o){E(),t(D).is(n)||s(t(D)),y(o),w(e,o,a),n&&(i(n),t(D).is(n)||s(n)),g()}).on("fotorama:load",function(e,o){t(O).data("fotorama").fullScreen&&l(t(D),z,C(o.activeFrame.$stageFrame)),y(o)}).on("fotorama:show",function(o,a){n=e.clone(t(D)),E()}).on("fotorama:fullscreenexit",function(e,o){s(t(D)),E(),h(!0)})}),o}});